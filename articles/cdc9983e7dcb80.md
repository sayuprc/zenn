---
title: "Next.js(App Router) ã§å®Ÿè£…ã™ã‚‹ gRPC ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ"
emoji: "ğŸ‘‹"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nextjs", "grpc"]
published: true
---

Next.js(App Router) ã§ gRPC Client ã‚’å®Ÿè£…ã—ã¾ã™ã€‚  

ä»Šå›ä½œæˆã—ãŸã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã‚ã‚Šã¾ã™ã€‚
https://github.com/sayuprc-learning/nextjs-grpc

## å‰æ

- gRPC ã‚µãƒ¼ãƒãƒ¼ãŒã‚ã‚‹
- App Router ã‚’åˆ©ç”¨ã—ãŸ Next.js ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
- proto ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰äº‹å‰ã«ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹[^1]
- é€šä¿¡æ–¹å¼ã¯ Unary PRC ã®ã¿

## gRPC ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å®Ÿè£…

ã¯ã˜ã‚ã«ã€gRPC ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å®Ÿè£…ã«å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å°å…¥ã—ã¾ã™ã€‚

```sh
$ npm i @grpc/grpc-js 

$ npm i -D grpc_tools_node_protoc_ts grpc-tools
```

å„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ã¤ã„ã¦ã®è©³ç´°ã¯ä»¥ä¸‹ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

https://github.com/grpc/grpc-node

æ¬¡ã« proto ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç™»éŒ²ã—ã¾ã™ã€‚

```json:package.json
{
  "scripts": {
    "gen": "grpc_tools_node_protoc --js_out=import_style=commonjs,binary:./app/_generated --grpc_out=grpc_js:./app/_generated --plugin=protoc-gen-grpc=./node_modules/.bin/grpc_tools_node_protoc_plugin --ts_out=grpc_js:./app/_generated -I ./proto ./proto/greet.proto"
  },
}
```

ã‚³ãƒ¼ãƒ‰ã®ç”Ÿæˆå…ˆ(`--js_out`,`--grpc_out`,`--ts_out`)ã¨å¯¾è±¡ã® proto ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ãƒ‘ã‚¹ã¯é©å®œå¤‰æ›´ã—ã¦ãã ã•ã„ã€‚  
ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®è¿½åŠ ãŒã§ããŸã‚‰ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```sh
$ npm run gen
```

`./app/_generated` é…ä¸‹ã«ã‚³ãƒ¼ãƒ‰ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

```
app/
 â””â”€ _generated
    â”œâ”€â”€ greet_grpc_pb.d.ts
    â”œâ”€â”€ greet_grpc_pb.js    // Service ã®å®Ÿè£…
    â”œâ”€â”€ greet_pb.d.ts
    â””â”€â”€ greet_pb.js         // message ã®å®Ÿè£…
```

æ¬¡ã« gRPC ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚  
ã“ã“ã§ã¯ Next.js ã® [Route Handlers](https://nextjs.org/docs/app/building-your-application/routing/route-handlers) ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã§å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

```mermaid
sequenceDiagram
  Next.js(ãƒšãƒ¼ã‚¸) ->> Next.js(API): Fetch API ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  Next.js(API) ->> gRPC Server: gRPC ã‚¹ã‚¿ãƒ–ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  gRPC Server -->> Next.js(API): ãƒ¬ã‚¹ãƒãƒ³ã‚¹
  Next.js(API) -->> Next.js(ãƒšãƒ¼ã‚¸): ãƒ¬ã‚¹ãƒãƒ³ã‚¹
```
### API

```ts:app/api/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { GreetServiceClient } from '../_generated/greet_grpc_pb'
import { GreetRequest, GreetResponse } from '../_generated/greet_pb'
import * as grpc from '@grpc/grpc-js'

const client = new GreetServiceClient('localhost:50051', grpc.ChannelCredentials.createInsecure())

export interface Params {
  name?: string
}

export interface GreetJsonResponse {
  message: string
}

export const GET = async (request: NextRequest): Promise<NextResponse<GreetJsonResponse>> => {
  const params = getParams(request)

  const grpcRequest = new GreetRequest()
  grpcRequest.setName(params?.name ?? '')

  const grpcResponse = await new Promise<GreetResponse>((resolve, reject) => {
    client.greet(grpcRequest, (serviceError: grpc.ServiceError | null, response: GreetResponse) => {
      if (serviceError) {
        reject(serviceError)
      }

      resolve(response)
    })
  })

  return NextResponse.json<GreetJsonResponse>({ message: grpcResponse.getMessage() })
}

const getParams = (request: NextRequest): Params => {
  const searchParams = request.nextUrl.searchParams

  return {
    name: searchParams.get('name') ?? undefined
  }
}
```

### ãƒšãƒ¼ã‚¸

```tsx:app/page.tsx
import { GreetJsonResponse } from './api/route'

export default async function Home() {
  // gRPC ã‚µãƒ¼ãƒãƒ¼ã«é€šä¿¡ã™ã‚‹ API ã‚’å‘¼ã³å‡ºã™
  const response = await fetch('http://localhost:3000/api')

  const json: GreetJsonResponse = await response.json()

  return (
    <div>
      {json.message}
    </div>
  )
}
```

## ã•ã„ã”ã«

Next.js ã§ gRPC ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å®Ÿè£…ãŒã§ãã¾ã—ãŸã€‚  
App Router ã¨ Page Router ã§ã¯ã¡ã‚‡ã£ã¨ã—ãŸã¨ã“ã‚ã§å‹æ‰‹ãŒé•ã†ã®ã§æ³¨æ„ãŒå¿…è¦ã§ã™ãŒã€åŸºæœ¬çš„ã«ã¯ã©ã¡ã‚‰ã‚‚åŒã˜è€ƒãˆæ–¹ã§å®Ÿè£…ã—ã¾ã™ã€‚

[^1]: `@grpc/proto-loader` ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§å‹•çš„ã« proto ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã“ã¨ã‚‚ã§ãã¾ã™
