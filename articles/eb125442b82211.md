---
title: "ã€Nuxt3ã€‘ ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã§ HMR ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹"
emoji: "ğŸ·"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["dokcer","nuxt3","nginx"]
published: true
---

å¯¾å¿œå†…å®¹ã¯åŸºæœ¬çš„ã«[ã“ã¡ã‚‰](https://zenn.dev/wwwave/articles/cc9d078fbf94fa)ã®è¨˜äº‹ã¨åŒæ§˜ã€‚

## ã‚¨ãƒ©ãƒ¼ã¨å¯¾å¿œ

![](/images/proxy-hmr/env.png)

ç”»åƒã®ã‚ˆã†ãªç’°å¢ƒã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤ºã•ã‚Œã‚‹ã€‚

> Mixed Content: The page at 'https://example.com/' was loaded over HTTPS, but attempted to connect to the insecure WebSocket endpoint 'ws://example.com/_nuxt/'. This request has been blocked; this endpoint must be available over WSS.

HMR ã§ã¯ WebSocket é€šä¿¡ã‚’åˆ©ç”¨ã—ã¦ãŠã‚Šã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã¯ `ws` ã«ãªã£ã¦ã„ã‚‹ã€‚  
HTTPS ã§é€šä¿¡ã™ã‚‹å ´åˆã€`wss` ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

è¨­å®šæ–¹æ³•ã‚’èª¿ã¹ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªè¨­å®šãŒå‡ºã¦ãã‚‹ãŒã€è‡ªåˆ†ã®ç’°å¢ƒã§ã¯åæ˜ ã•ã‚Œãªã‹ã£ãŸã€‚

```ts:nuxt.confg.ts
export default defineNuxtConfig({
  vite: {
    server: {
      hmr: {
        protocol: 'wss',
      },
    },
  },
})
```

ä»£ã‚ã‚Šã«[ã“ã¡ã‚‰](https://zenn.dev/coedo/scraps/b0d1ae5de09f63)ã®ã‚¹ã‚¯ãƒ©ãƒƒãƒ—ã‚’å‚è€ƒã«ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã™ã‚‹ã€‚

```ts:nuxt.config.ts
export default defineNuxtConfig({
  hooks: {
    'vite:extendConfig' (viteInlineConfig, env) {
      viteInlineConfig.server = {
        ...viteInlineConfig.server,
        {
          hmr: {
            protocol: 'wss',
          },
        },
      },
    },
  },
})
```

ã“ã‚Œã§ `wss` ã§é€šä¿¡ã‚’ã™ã‚‹ã‚ˆã†ã«ãªã£ãŸãŒã€Docker ã‚³ãƒ³ãƒ†ãƒŠã®ãƒãƒ¼ãƒˆãŒé–‹ã„ã¦ã„ãªã„ãŸã‚ç–é€šã«å¤±æ•—ã™ã‚‹ã€‚

> WebSocket connection to 'wss://example.com:24678/_nuxt/' failed: 

ãƒãƒ¼ãƒˆé–‹æ”¾ä»¥å¤–ã«ã‚‚ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã•ã°ã‘ã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

```ts:nuxt.config.ts
export default defineNuxtConfig({
  hooks: {
    'vite:extendConfig' (viteInlineConfig, env) {
      viteInlineConfig.server = {
        ...viteInlineConfig.server,
        {
          hmr: {
            protocol: 'wss',
            // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒ WebSocket ã‚µãƒ¼ãƒãƒ¼ã«é€šä¿¡ã™ã‚‹ã¨ãã«ä½¿ç”¨ã™ã‚‹ãƒãƒ¼ãƒˆ
            clientPort: 443,
            // WebSocket é€šä¿¡æ™‚ã®ãƒ‘ã‚¹(Nginx ã®è¨­å®šã¨åˆã‚ã›ã‚Œã°ä½•ã§ã‚‚ã‚ˆã„)
            path: 'hmr/',
          },
        },
      },
    },
  },
})
```

```conf:site.conf
server {
    listen 443 ssl;
    ssl_certificate /etc/nginx/certs/server.crt;
    ssl_certificate_key /etc/nginx/certs/server.key;

    server_name local.profile.sayuprc.dev;

    location / {
        proxy_pass http://host.docker.internal:3001/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ä»¥ä¸‹ã‚’è¿½è¨˜
    # /_nuxt/hmr/ ã«æ¥ãŸã‚¢ã‚¯ã‚»ã‚¹ã¯ WebSocket ã‚µãƒ¼ãƒãƒ¼ã«è»¢é€ã™ã‚‹
    location /_nuxt/hmr/ {
        # WebSocket é€šä¿¡ã‚’è¡Œã†ã‚µãƒ¼ãƒãƒ¼ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® 24678 ãƒãƒ¼ãƒˆ
        proxy_pass http://host.docker.internal:24678/;
        # ä»¥ä¸‹ã®è¨­å®šã§ WebSocket ã«å¯¾å¿œã™ã‚‹
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

```yaml:compose.yaml
services:
  node:
    image: example
    environment:
      LANG: ja_JP.UTF-8
      TZ: Asia/Tokyo
    tty: true
    ports:
      - 3000:3000
      - 24678:24678 # WebSocket é€šä¿¡ã‚’è¡Œã†ã‚µãƒ¼ãƒãƒ¼ã®ãƒãƒ¼ãƒˆç•ªå·
    volumes:
      - ./src:/app
```

ã“ã‚Œã§ HMR ãŒåŠ¹ãã‚ˆã†ã«ãªã‚‹ã€‚

## å‚è€ƒ

[Nuxt 3.8 ã§ HMR ãŒåŠ¹ã‹ãªããªã£ãŸã¨ãã®å¯¾å¿œæ–¹æ³•](https://zenn.dev/coedo/scraps/b0d1ae5de09f63)
[Docker+Nuxt3+SSL+Nginx-Proxyç’°å¢ƒã§HMRã‚’ä½¿ãˆã‚‹æ§˜ã«ã™ã‚‹](https://zenn.dev/wwwave/articles/cc9d078fbf94fa)
