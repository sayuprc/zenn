---
title: "ãƒ“ãƒ¥ãƒ¼ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹ã‚«ãƒ©ãƒ ã®å®šç¾©ã‚’å¤‰ãˆãŸã¨ãã®æŒ™å‹•ã¾ã¨ã‚"
emoji: "ğŸ—‚"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["DB", "rdb", "postgresql", "mysql", "sqlserver"]
published: true
---

SQL Server ã‚’ä½¿ã£ã¦ã„ã¦ã€ãƒ“ãƒ¥ãƒ¼ãŒå‚ç…§ã—ã¦ã„ã‚‹ã‚«ãƒ©ãƒ ã®é•·ã•ã‚’å¤‰æ›´ã—ã¦ã‚‚ãƒ“ãƒ¥ãƒ¼å´ã®é•·ã•ãŒå¤‰ã‚ã‚‰ãªã„ã¨ã„ã†ç¾è±¡ã«ã‚ã£ãŸã€‚
ä»–ã® DB ã¯ã©ã†ãªã‚“ã ã‚ã†ï¼Ÿã¨æ€ã£ãŸã®ã§æ¤œè¨¼ã—ã¦ã¿ã¾ã—ãŸã€‚

## ç’°å¢ƒ

ä»Šå›ã¯ Docker ä¸Šã«ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

|åç§°|ãƒãƒ¼ã‚¸ãƒ§ãƒ³|
|---|---|
|MySQL|8.0.30|
|PostgreSQL|14.0|
|SQL Server|2019 15.0.4236.7|


:::details Docker ã®è¨­å®š

#### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

`database/init` é…ä¸‹ã«åˆæœŸåŒ–ç”¨ã®ã‚¯ã‚¨ãƒªã‚’ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚

`database/infra` é…ä¸‹ã« Dockerfile ã‚’é…ç½®ã—ã¦ã„ã¾ã™ã€‚

```
.
â”œâ”€database
â”‚  â””â”€init
â”‚      â”œâ”€mysql
â”‚      â”œâ”€postgresql
â”‚      â””â”€sqlserver
â””â”€infra
   â”œâ”€mysql
   â”œâ”€postgresql
   â””â”€sqlserver
```

```yml:docker-compse.yml
version: '3.9'

services:
  mysql:
    build: ./infra/mysql
    environment:
      MYSQL_ROOT_PASSWORD: 'root'
    volumes:
      - ./database/init/mysql:/docker-entrypoint-initdb.d
    ports:
      - 3306:3306

  postgresql:
    build: ./infra/postgresql
    environment:
      POSTGRES_USER: 'postgres'
      POSTGRES_PASSWORD: 'postgres'
    volumes:
      - ./database/init/postgresql:/docker-entrypoint-initdb.d
    ports:
      - 5432:5432

  sqlserver:
    build: ./infra/sqlserver
    environment:
      ACCEPT_EULA: 'Y'
      SA_PASSWORD: 'rootRootr00t'
    volumes:
      - ./database/init/sqlserver:/docker-entrypoint-initdb.d
    ports:
      - 1433:1433
```

:::

## æ¤œè¨¼æ–¹æ³•

ãã‚Œãã‚Œã® DB ã§æº–å‚™ã—ã¦ãŠã„ãŸã‚¯ã‚¨ãƒªã‚’æµã—ã¾ã™ã€‚(ä¸‹è¨˜ã‚¯ã‚¨ãƒªã¯ MySQL ç”¨ã§ã™ã€‚)

```sql
-- DBã®ä½œæˆ
CREATE DATABASE sample;

USE sample;

-- ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
CREATE TABLE users (
  id INT,
  name VARCHAR(10),
  PRIMARY KEY (id)
);

-- VIEWã®ä½œæˆ
CREATE VIEW user_view AS
SELECT
  *
FROM
  users;

-- ãƒ‡ãƒ¼ã‚¿æŠ•å…¥
INSERT INTO
  users(id, name)
VALUES
  (1, 'hogeå¤ªéƒ'),
  (2, 'fugaæ¬¡éƒ'),
  (3, 'piyoä¸‰éƒ');

-- æº–å‚™ãŒã§ããŸçŠ¶æ…‹ã§ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ãƒ“ãƒ¥ãƒ¼ã®å®šç¾©ã‚’è¦‹ã‚‹
DESC users;
DESC user_view;

-- ã‚«ãƒ©ãƒ ã®å®šç¾©ã‚’å¤‰æ›´
-- ä»Šå›ã¯nameã‚«ãƒ©ãƒ ã‚’ VARCHAR(10) ã‹ã‚‰ VARCHAR(20) ã«ã™ã‚‹ã€‚
ALTER TABLE users MODIFY name VARCHAR(20);

-- å¤‰æ›´å¾Œã®å®šç¾©ã‚’è¦‹ã‚‹
DESC users;
DESC user_view;
```

## çµæœ

|DB|æŒ™å‹•|
|---|---|
|MySQL|ALTERæˆåŠŸã€‚è‡ªå‹•çš„ã«ãƒ“ãƒ¥ãƒ¼å´ã®å®šç¾©ã‚‚å¤‰ã‚ã‚‹ã€‚|
|PostgreSQL|ALTERå¤±æ•—ã€‚ãƒ“ãƒ¥ãƒ¼ãªã©ã§å‚ç…§ã—ã¦ã„ã‚‹ã‚«ãƒ©ãƒ ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã¯ã§ããªã„ã€‚|
|SQL Server|ALTERæˆåŠŸã€‚ãƒ“ãƒ¥ãƒ¼å´ã®å®šç¾©ã¯å¤‰ã‚ã‚‰ãªã„ã€‚|

:::details ã‚¯ã‚¨ãƒªã®å®Ÿè¡Œçµæœ

### MySQL

ALTER æ–‡å®Ÿè¡Œå¾Œã€ãƒ“ãƒ¥ãƒ¼ã®å®šç¾©ã‚‚é€£å‹•ã—ã¦å¤‰ã‚ã£ã¦ã„ã¾ã™ã€‚

#### å¤‰æ›´å‰

```sql
-- ãƒ†ãƒ¼ãƒ–ãƒ«
mysql> DESC users;
+-------+-------------+------+-----+---------+-------+
| Field | Type        | Null | Key | Default | Extra |
+-------+-------------+------+-----+---------+-------+
| id    | int         | NO   | PRI | NULL    |       |
| name  | varchar(10) | YES  |     | NULL    |       |
+-------+-------------+------+-----+---------+-------+
2 rows in set (0.00 sec)

-- ãƒ“ãƒ¥ãƒ¼
mysql> DESC user_view;
+-------+-------------+------+-----+---------+-------+
| Field | Type        | Null | Key | Default | Extra |
+-------+-------------+------+-----+---------+-------+
| id    | int         | NO   |     | NULL    |       |
| name  | varchar(10) | YES  |     | NULL    |       |
+-------+-------------+------+-----+---------+-------+
2 rows in set (0.00 sec)
```

#### å¤‰æ›´å¾Œ

```sql
-- ã‚«ãƒ©ãƒ å®šç¾©å¤‰æ›´
mysql> ALTER TABLE users MODIFY name VARCHAR(20);
Query OK, 0 rows affected (0.01 sec)
Records: 0  Duplicates: 0  Warnings: 0

-- ãƒ†ãƒ¼ãƒ–ãƒ«
mysql> desc users;
+-------+-------------+------+-----+---------+-------+
| Field | Type        | Null | Key | Default | Extra |
+-------+-------------+------+-----+---------+-------+
| id    | int         | NO   | PRI | NULL    |       |
| name  | varchar(20) | YES  |     | NULL    |       |
+-------+-------------+------+-----+---------+-------+
2 rows in set (0.00 sec)

-- ãƒ“ãƒ¥ãƒ¼
mysql> DESC user_view;
+-------+-------------+------+-----+---------+-------+
| Field | Type        | Null | Key | Default | Extra |
+-------+-------------+------+-----+---------+-------+
| id    | int         | NO   |     | NULL    |       |
| name  | varchar(20) | YES  |     | NULL    |       |
+-------+-------------+------+-----+---------+-------+
2 rows in set (0.00 sec)
```

### PostgreSQL

ALTER æ–‡ãŒã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚Šå®Ÿè¡Œã§ãã¾ã›ã‚“ã§ã—ãŸã€‚
ãƒ“ãƒ¥ãƒ¼ã§å‚ç…§ã—ã¦ã„ã‚‹å ´åˆã¯å¤‰æ›´ã§ããªã„ã‚ˆã†ã§ã™ã€‚

#### å¤‰æ›´å‰

```sql
-- ãƒ†ãƒ¼ãƒ–ãƒ«
sample=# \d users;
                      Table "public.users"
 Column |         Type          | Collation | Nullable | Default
--------+-----------------------+-----------+----------+---------
 id     | integer               |           | not null |
 name   | character varying(10) |           |          |
Indexes:
    "users_pkey" PRIMARY KEY, btree (id)

-- ãƒ“ãƒ¥ãƒ¼
sample=# \d user_view;
                     View "public.user_view"
 Column |         Type          | Collation | Nullable | Default
--------+-----------------------+-----------+----------+---------
 id     | integer               |           |          |
 name   | character varying(10) |           |          |
```

#### å¤‰æ›´å¾Œ

```sql
-- ã‚«ãƒ©ãƒ å®šç¾©å¤‰æ›´
sample=# ALTER TABLE users ALTER name TYPE VARCHAR(20);
ERROR:  cannot alter type of a column used by a view or rule
DETAIL:  rule _RETURN on view user_view depends on column "name"
```

### SQL Server

ALTER æ–‡ãŒæˆåŠŸã—ã¦ã‚‚ãƒ“ãƒ¥ãƒ¼ã®å®šç¾©ã¯å¤‰ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚

#### å¤‰æ›´å‰

![](/images/rdb-alter/before-sql-server.png)

#### å¤‰æ›´å¾Œ

![](/images/rdb-alter/alter-sql-server.png)
![](/images/rdb-alter/after-sql-server.png)

å®šç¾©ã¯å¤ã„ã§ã™ãŒã€ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã¯æ­£å¸¸ã«ã§ãã¾ã—ãŸã€‚

![](/images/rdb-alter/insert-sql-server.png)

:::

## ã¾ã¨ã‚

PostgreSQL ãŒå®šç¾©å¤‰æ›´ã§ããªã„ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã®ã«ã¯é©šãã¾ã—ãŸã€‚
ä¸€è¦‹ã™ã‚‹ã¨é¢å€’ãªä»•æ§˜ã«æ€ãˆã¾ã™ãŒã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®‰å…¨ã«ä¿ã¤ã“ã¨ãŒã§ãã‚‹ã¨ã„ã†é¢ã§ã¯ä¸€ç•ªã„ã„æŒ™å‹•ã ã¨æ„Ÿã˜ã¦ã„ã¾ã™ã€‚

SQL Server ã‚‚ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆæ™‚ã«[ã‚ªãƒ—ã‚·ãƒ§ãƒ³](https://docs.microsoft.com/en-us/sql/t-sql/statements/create-view-transact-sql?view=sql-server-ver16#schemabinding)ã‚’ã¤ã‘ã‚‹ã“ã¨ã§åŒæ§˜ã®æŒ™å‹•ã‚’ã™ã‚‹ã‚ˆã†ã«ã§ãã‚‹ã‚ˆã†ã§ã™ã€‚
å€‹äººçš„ã«ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãã†ã—ã¦æ¬²ã—ã‹ã£ãŸã§ã™ã€‚

MySQL ã¯é€£å‹•ã—ã¦å¤‰ã‚ã£ã¦ãã‚Œã‚‹ã®ã§å‹ã®å¤‰æ›´ã«é–¢ã—ã¦ã¯ä½•ã‚‚è€ƒãˆãªãã¦ã‚ˆã•ãã†ã§ã™ã­ã€‚
ãŸã ã—ã€[ã‚«ãƒ©ãƒ ã®è¿½åŠ ã‚„å‰Šé™¤ã¯é€£å‹•ã—ãªã„](https://dev.mysql.com/doc/refman/8.0/en/create-view.html)ã‚ˆã†ãªã®ã§ã€è¿½åŠ å‰Šé™¤ã‚’è¡Œã£ãŸå ´åˆã¯é©å®œå†æ§‹ç¯‰ãŒå¿…è¦ã§ã™ã€‚(ã“ã‚Œã¯ SQL Server ã‚‚åŒæ§˜ã§ã™ã€‚)

## å‚è€ƒ

[MySQL :: MySQL 8.0 Reference Manual :: 13.1.23 CREATE VIEW Statement](https://dev.mysql.com/doc/refman/8.0/en/create-view.html)
[PostgreSQL: Documentation: 14: CREATE VIEW](https://www.postgresql.org/docs/14/sql-createview.html)
[CREATE VIEW (Transact-SQL) - SQL Server | Microsoft Docs](https://docs.microsoft.com/en-us/sql/t-sql/statements/create-view-transact-sql?view=sql-server-ver16)
